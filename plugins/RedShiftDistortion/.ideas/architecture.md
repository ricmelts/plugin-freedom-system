# DSP Architecture: RedShiftDistortion

**CRITICAL CONTRACT:** This specification is immutable during Stages 1-4 implementation. Stage 1 Planning cannot proceed without this file. Stage 2 (DSP) implements this exact architecture.

**Generated by:** Stage 0 Research (2026-02-05)
**Revised:** 2026-02-08 (Final - Stereo Width + Cumulative Doppler Shift)
**Referenced by:** Stage 1 (Planning), Stage 2 (DSP Implementation)
**Purpose:** DSP specification defining processing components, signal flow, and JUCE module usage

---

## Core Architecture

**Processing Type:** Series (sequential) signal chain with cumulative feedback effects
**Signal Flow:** Input → Stereo Width → Tape Delay (with Feedback: Granular Doppler → Saturation → Filters) → Master Output

Each stage can be bypassed independently for troubleshooting:
- `bypassStereoWidth` - Bypass stereo width modulation stage
- `bypassDelay` - Bypass entire tape delay stage (including feedback loop)
- `bypassDoppler` - Bypass granular pitch shifting (keeps delay + saturation)
- `bypassSaturation` - Bypass tube saturation stage

---

## Core Components

### Stage 1: Stereo Width Modulation

**JUCE Class:** Custom implementation using stereo delay lines
**Purpose:** Create stereo width via differential L/R delay times (spatial positioning)
**Parameters Affected:** `stereoWidth` (-100% to +100%)
**Configuration:**
  - Stereo delay lines with differential delay times:
    - Left channel: `d0 + (ITD_HALF * stereoControl)`
    - Right channel: `d0 - (ITD_HALF * stereoControl)`
  - ITD_HALF = 260ms (maximum L/R differential for wide stereo imaging)
  - Base delay (d0) = 0ms (asymmetric modulation around neutral point)
  - stereoControl calculation: `stereoWidth / 100.0f` (maps -100% to +100% → -1.0 to +1.0)
  - Exponential smoothing with 10ms time constant (prevents clicks)
  - No LFO modulation (static stereo positioning)

**Bypass:** `bypassStereoWidth = true` sets stereoControl to 0.0 (neutral, mono)

**Purpose:** Separate spatial positioning from pitch shifting (stereo width ≠ doppler shift)

---

### Stage 2: Tape Delay (with Feedback Loop)

**JUCE Class:** `juce::dsp::DelayLine<float, juce::dsp::DelayLineInterpolationTypes::Linear>`
**Purpose:** Provide tape-style delay with feedback loop containing cumulative effects
**Parameters Affected:** `feedback` (0-95%), `filterBandLow` (20-20000Hz highpass), `filterBandHigh` (20-20000Hz lowpass)
**Configuration:**
  - Maximum delay buffer: 300ms at 192kHz
  - Feedback loop: Delayed signal fed back to input (scaled by feedback gain 0.0-0.95)
  - Feedback path contains (in order):
    1. Granular pitch shifter (cumulative doppler shift)
    2. Tube saturation (cumulative warmth)
    3. Hi-cut filter (lowpass)
    4. Lo-cut filter (highpass)
    5. Feedback gain
  - Linear interpolation for smooth delay time modulation

**Bypass:** `bypassDelay = true` passes input directly to next stage (no delay, no feedback)

**Signal Flow:**
```
Input (from stereo width stage)
  ↓
  + ← Filtered Feedback Signal
  ↓
Write to Delay Line
  ↓
Read from Delay Line (delayed signal)
  ↓
  ├─→ STAGE 3: Granular Pitch Shifter (CUMULATIVE doppler)
  ├─→ STAGE 4: Tube Saturation (CUMULATIVE warmth)
  ├─→ Hi-Cut Filter (lowpass)
  ├─→ Lo-Cut Filter (highpass)
  ├─→ Scale by Feedback Gain
  └─→ Feed back to input
  ↓
Output to Master Output Stage
```

---

### Stage 3: Granular Pitch Shifter (Cumulative Doppler in Feedback Loop)

**JUCE Class:** Custom implementation using granular synthesis
**Purpose:** Apply cumulative pitch shifting to delayed signal (true doppler shift effect)
**Parameters Affected:** `dopplerShift` (-50% to +50%), `grainSize` (25-200ms), `grainOverlap` (2x or 4x)
**Configuration:**
  - Grain buffer size: `grainSize` milliseconds (default 100ms at 48kHz = 4800 samples)
  - Grain overlap: `grainOverlap` simultaneous grains (2x or 4x, default 4x)
  - Grain advance: `grainSize / grainOverlap` (75% overlap at 4x, 50% overlap at 2x)
  - Window function: Hann window (smooth attack/release, minimizes clicks)
  - Pitch shift calculation:
    - Semitones: `(dopplerShift / 100.0f) * 12.0f` (±50% → ±12 semitones / ±1 octave)
    - Pitch ratio: `std::pow(2.0f, semitones / 12.0f)`
    - Examples:
      - dopplerShift = -50% → -12 semitones → ratio = 0.5 (one octave down, red shift)
      - dopplerShift = 0% → 0 semitones → ratio = 1.0 (no shift)
      - dopplerShift = +50% → +12 semitones → ratio = 2.0 (one octave up, blue shift)
  - **CUMULATIVE BEHAVIOR:** Pitch shift applied in feedback loop
    - Repeat 1: pitch ratio = 2^(semitones / 12)
    - Repeat 2: pitch ratio = 2^(2 × semitones / 12)
    - Repeat 3: pitch ratio = 2^(3 × semitones / 12)
    - Eventually shifts out of audible range (natural decay with feedback)

**Bypass:** `bypassDoppler = true` skips granular pitch shifting (linear passthrough)

**Placement rationale:** Granular pitch shifter BEFORE saturation in feedback loop
  - Creates true unidirectional doppler shift (pitch rises/falls consistently)
  - Each repeat shifts pitch further (cumulative effect)
  - Authentic doppler behavior (approaching = pitch rises, receding = pitch falls)

**Granular Synthesis Implementation:**
- Grain buffer: Circular buffer holding `grainSize` samples
- Overlap-add: 4 simultaneous grains (or 2 for lower CPU)
- Grain playback: Variable-rate resampling at `pitchRatio`
- Hann window formula: `window[i] = 0.5 * (1.0 - std::cos(2π * i / grainSize))`
- Overlap-add output: Sum of all active grains (weighted by Hann window)

**Advanced Settings (User-Adjustable):**
- `grainSize`: 25-200ms (default 100ms)
  - Smaller = less latency, more CPU, possible graininess
  - Larger = more latency, less CPU, smoother sound
- `grainOverlap`: 2x or 4x (default 4x)
  - 2x = 50% overlap, lower CPU, acceptable quality
  - 4x = 75% overlap, higher CPU, smooth quality

---

### Stage 4: Tube Saturation (Cumulative in Feedback Path)

**JUCE Class:** Custom implementation using `std::tanh()` waveshaping
**Purpose:** Apply warm harmonic distortion to pitch-shifted delayed signal (cumulative tape warmth)
**Parameters Affected:** `saturation` (-12dB to +24dB)
**Configuration:**
  - Saturation range: -12dB to +24dB maps to gain factor 0.25x to 15.85x
  - Formula: `gain = std::pow(10.0f, saturationDb / 20.0f)` (dB to linear gain)
  - Transfer function: `output = std::tanh(gain * input)`
  - Generates primarily 2nd and 3rd order harmonics (warm tube character)
  - Applied per-sample AFTER granular pitch shifter, BEFORE feedback filters
  - **Placement rationale:** Saturation after pitch shifting allows saturating the shifted signal
  - **CUMULATIVE BEHAVIOR:** Each repeat gets progressively more saturated (authentic tape echo)
  - No oversampling (saturation is moderate, aliasing minimal)

**Bypass:** `bypassSaturation = true` skips tanh waveshaping (linear passthrough)

---

### Stage 5: Master Output Gain

**JUCE Class:** Simple gain multiplication
**Purpose:** Final output level control
**Parameters Affected:** `masterOutput` (-60dB to +12dB)
**Configuration:**
  - dB to linear conversion: `gain = std::pow(10.0f, db / 20.0f)`
  - Applied to final stereo output after all processing stages

---

## Series Processing Chain

```
Input (Stereo)
  ↓
┌──────────────────────────────────────────────────────────────┐
│ STAGE 1: STEREO WIDTH MODULATION                             │
│                                                                │
│ Left Channel:  d0 + (260ms * stereoControl)                  │
│ Right Channel: d0 - (260ms * stereoControl)                  │
│                                                                │
│ stereoControl = stereoWidth / 100.0 (range: -1.0 to +1.0)    │
│                                                                │
│ Bypass: bypassStereoWidth                                     │
└──────────────────────────────────────────────────────────────┘
  ↓
┌──────────────────────────────────────────────────────────────┐
│ STAGE 2: TAPE DELAY (with Cumulative Feedback Loop)          │
│                                                                │
│ Input + Filtered Feedback                                     │
│   ↓                                                            │
│ Write to Delay Line (300ms max)                              │
│   ↓                                                            │
│ Read Delayed Signal                                           │
│   ↓                                                            │
│   ├─→ STAGE 3: Granular Pitch Shifter (CUMULATIVE)           │
│   │     ← dopplerShift parameter                             │
│   │     Pitch ratio = 2^((dopplerShift/100)*12/12)           │
│   │     Cumulative: Each repeat shifts further               │
│   │     Bypass: bypassDoppler                                 │
│   ↓                                                            │
│   ├─→ STAGE 4: Tube Saturation (CUMULATIVE)                  │
│   │     ← saturation parameter                               │
│   │     tanh waveshaping, cumulative in feedback             │
│   │     Bypass: bypassSaturation                             │
│   ↓                                                            │
│   ├─→ Hi-Cut Filter (lowpass) ← filterBandHigh               │
│   ├─→ Lo-Cut Filter (highpass) ← filterBandLow               │
│   ├─→ Scale by Feedback Gain ← feedback parameter            │
│   └─→ Feed back to input                                      │
│   ↓                                                            │
│ Output delayed + doppler-shifted + saturated signal           │
│                                                                │
│ Bypass: bypassDelay (skips entire delay + feedback loop)     │
└──────────────────────────────────────────────────────────────┘
  ↓
┌──────────────────────────────────────────────────────────────┐
│ STAGE 5: MASTER OUTPUT                                        │
│                                                                │
│ Final Gain Staging ← masterOutput (-60dB to +12dB)           │
└──────────────────────────────────────────────────────────────┘
  ↓
Output (Stereo)
```

**Routing notes:**
- Series architecture (sequential processing, no parallel paths)
- Stereo width stage processes first (spatial positioning, separate from doppler)
- Delay stage receives stereo-width-modulated signal
- Granular pitch shifter applied INSIDE feedback loop (cumulative doppler shift)
- Saturation applied after pitch shifting (saturates the shifted signal)
- Feedback filters applied after saturation (tape frequency degradation)
- Master output gain applied to final signal

---

## Parameter Mapping

| Parameter ID | Type | Range | Default | DSP Component | Usage |
|-------------|------|-------|---------|---------------|-------|
| **Main Controls** ||||||
| stereoWidth | Float | -100.0 to 100.0 % | 0.0 % | Stereo Width (Stage 1) | L/R delay differential (±260ms max) |
| feedback | Float | 0.0 to 95.0 % | 0.0 % | Tape Delay (Stage 2) | Feedback gain (0.0 to 0.95) |
| filterBandLow | Float | 20.0 to 20000.0 Hz | 100.0 Hz | Tape Delay Feedback | Highpass cutoff (removes low frequencies) |
| filterBandHigh | Float | 20.0 to 20000.0 Hz | 8000.0 Hz | Tape Delay Feedback | Lowpass cutoff (removes high frequencies) |
| dopplerShift | Float | -50.0 to 50.0 % | 0.0 % | Granular Pitch Shifter (Stage 3) | Pitch shift per repeat (±12 semitones, CUMULATIVE) |
| saturation | Float | -12.0 to 24.0 dB | 0.0 dB | Tube Saturation (Stage 4) | Gain factor (0.25x to 15.85x, CUMULATIVE in feedback) |
| masterOutput | Float | -60.0 to 12.0 dB | 0.0 dB | Master Output (Stage 5) | Final output gain |
| **Bypass Controls** ||||||
| bypassStereoWidth | Bool | On/Off | Off | Stereo Width (Stage 1) | Bypass stereo width modulation |
| bypassDelay | Bool | On/Off | Off | Tape Delay (Stage 2) | Bypass entire delay + feedback loop |
| bypassDoppler | Bool | On/Off | Off | Granular Pitch Shifter (Stage 3) | Bypass pitch shifting (keeps delay + saturation) |
| bypassSaturation | Bool | On/Off | Off | Tube Saturation (Stage 4) | Bypass saturation stage |
| **Advanced Settings** ||||||
| grainSize | Float | 25.0 to 200.0 ms | 100.0 ms | Granular Pitch Shifter (Stage 3) | Grain buffer size (quality vs CPU trade-off) |
| grainOverlap | Choice | 2x or 4x | 4x | Granular Pitch Shifter (Stage 3) | Simultaneous grains (2x = lower CPU, 4x = smoother) |

**Total Parameter Count:** 15 (7 main + 4 bypass + 2 advanced)

**Parameters Removed (from previous revision):**
- ~~`lfoRate`~~ - Removed (no LFO modulation)
- ~~`lfoDepth`~~ - Removed (no LFO modulation)
- ~~`lfoTempoSync`~~ - Removed (no LFO modulation)
- ~~`dopplerShift` (as stereo width)~~ - Split into `stereoWidth` (spatial) and `dopplerShift` (pitch)

**Parameters Added:**
- `stereoWidth` - Separated from doppler shift (spatial positioning)
- `grainSize` - Advanced setting for granular quality
- `grainOverlap` - Advanced setting for granular quality

---

## Algorithm Details

### Stereo Width Modulation

**Algorithm:** Differential L/R delay times (static spatial positioning)

**Implementation notes:**
- Stereo delay lines with opposite differential offsets:
  - Left delay: `d0 + (ITD_HALF * stereoControl)` samples
  - Right delay: `d0 - (ITD_HALF * stereoControl)` samples
- ITD_HALF = 260ms (0.260 seconds * sample rate)
- Base delay d0 = 0ms (asymmetric modulation around neutral point)
- stereoControl calculation: `stereoWidth / 100.0f` (maps -100% to +100% → -1.0 to +1.0)
- Exponential smoothing for stereoControl changes:
  - Time constant: 10ms (prevents clicks on parameter changes)
  - Formula: `x(n) = x(n-1) + alpha * (target - x(n-1))`
  - Alpha: `1.0f - exp(-1.0f / (0.01 * sampleRate))`
- No LFO modulation (stereo width is static, not time-varying)

### Granular Pitch Shifting (Cumulative Doppler)

**Algorithm:** Granular synthesis with pitch-shifted grain playback (overlap-add)

**Implementation notes:**
- Grain size: User-adjustable (25-200ms, default 100ms)
- Grain overlap: User-adjustable (2x or 4x, default 4x)
- Grain advance: `grainSize / grainOverlap`
  - 4x overlap: advance every 25ms (75% overlap)
  - 2x overlap: advance every 50ms (50% overlap)
- Window function: Hann window (smooth attack/release, minimizes clicks)
  - Formula: `window[i] = 0.5 * (1.0 - std::cos(2π * i / grainSize))`
- Pitch shift calculation:
  - Semitones from dopplerShift: `semitones = (dopplerShift / 100.0f) * 12.0f`
  - Pitch ratio: `ratio = std::pow(2.0f, semitones / 12.0f)`
- Grain playback:
  - Read from delay output at variable rate (pitch ratio)
  - Apply Hann window to grain samples
  - Overlap-add 4 grains (or 2 grains) for continuous output
- **Cumulative behavior in feedback loop:**
  - Each feedback iteration applies ANOTHER pitch shift
  - Example with dopplerShift = +50% (+12 semitones):
    - Original: 440 Hz
    - Repeat 1: 880 Hz (+1 octave)
    - Repeat 2: 1760 Hz (+2 octaves)
    - Repeat 3: 3520 Hz (+3 octaves)
    - Eventually shifts out of audible range (natural decay)

**Artifact mitigation:**
- Large grain size (100ms default) reduces graininess
- High overlap (4x default) smooths transitions
- Hann window eliminates clicks at grain boundaries

### Tape Delay with Feedback

**Algorithm:** Delay line with cumulative feedback loop (granular doppler + saturation + filtering)

**Implementation notes:**
- Delay line buffer: 300ms max at 192kHz = 57,600 samples
- Linear interpolation for smooth delay time modulation
- Feedback loop processing order:
  1. Read delayed signal from delay line
  2. Apply granular pitch shifter (cumulative doppler)
  3. Apply saturation (cumulative warmth)
  4. Apply hi-cut filter (lowpass) at filterBandHigh frequency
  5. Apply lo-cut filter (highpass) at filterBandLow frequency
  6. Scale by feedback gain: `feedbackPercent / 100.0f` (0-95% → 0.0-0.95)
  7. Add filtered feedback to input signal
- Dual-band filter (hi-cut + lo-cut):
  - Hi-cut: `juce::dsp::IIR::Coefficients<float>::makeLowPass(sampleRate, filterBandHigh)`
  - Lo-cut: `juce::dsp::IIR::Coefficients<float>::makeHighPass(sampleRate, filterBandLow)`
  - Applied in series: lo-cut → hi-cut
  - Simulates tape frequency response (high frequency rolloff + proximity effect compensation)

### Tube Saturation

**Algorithm:** Hyperbolic tangent waveshaping with adjustable drive (cumulative in feedback loop)

**Implementation notes:**
- Transfer function: `output = std::tanh(gain * input)`
- Gain curve: Exponential mapping from dB to linear gain
  - Formula: `gain = std::pow(10.0f, saturationDb / 20.0f)`
  - -12dB → 0.25x gain (clean, subtle saturation)
  - 0dB → 1.0x gain (unity gain, mild saturation)
  - +12dB → 3.98x gain (moderate tube warmth)
  - +24dB → 15.85x gain (heavy tube distortion)
- Saturation characteristics:
  - tanh() produces primarily 2nd and 3rd order harmonics (warm, musical)
  - Soft clipping (smooth transition to saturation region)
  - Asymmetric distortion (mimics tube behavior)
- **Placement:** Applied AFTER granular pitch shifter, BEFORE feedback filters
  - Saturates the pitch-shifted signal
  - Creates cumulative saturation (each repeat gets progressively more saturated)
- No oversampling needed (moderate saturation, minimal aliasing)
- Applied per-sample in processBlock loop

---

## System Architecture

### State Persistence

**What state is saved:**
- APVTS parameters: stereoWidth, feedback, filterBandLow, filterBandHigh, dopplerShift, saturation, masterOutput, bypassStereoWidth, bypassDelay, bypassDoppler, bypassSaturation, grainSize, grainOverlap (automatic)
- No custom state needed (all state is parameter-based)

**Serialization format:**
- APVTS: Automatic via `AudioProcessorValueTreeState`
- XML via ValueTree (JUCE standard)

**JUCE classes:**
- `juce::AudioProcessorValueTreeState` - Parameter persistence (automatic)
- `juce::ValueTree` - State tree serialization

**Save/restore methods:**
- `getStateInformation(MemoryBlock& destData)` - Serialize APVTS state to XML
- `setStateInformation(const void* data, int sizeInBytes)` - Deserialize APVTS state from XML

**Restore behavior:**
- All parameters restored to saved values automatically by APVTS
- No validation needed (parameters have defined ranges)
- No version migration needed (v1.0.0 initial release)

---

## Integration Points

### Feature Dependencies

- **Stereo Width → Tape Delay:** Stereo-width-modulated signal fed to delay input
- **Tape Delay → Granular Pitch Shifter:** Pitch shifter reads delayed signal
- **Granular Pitch Shifter → Saturation:** Saturation applied to pitch-shifted signal in feedback loop
- **Saturation → Feedback Filters:** Filters applied after saturation (tape frequency degradation)
- **Feedback Filters → Delay Input:** Filtered signal fed back to delay input

### Parameter Interactions

- **stereoWidth creates spatial positioning:**
  - Controls L/R delay time differential (±260ms maximum)
  - Negative = narrow stereo (sounds distant)
  - Zero = mono (no width)
  - Positive = wide stereo (sounds present/close)
  - Independent of dopplerShift (spatial ≠ frequency)

- **dopplerShift creates pitch movement:**
  - Controls granular pitch shift amount (±12 semitones per repeat)
  - Negative = red shift (pitch down, receding sound)
  - Zero = no pitch shift
  - Positive = blue shift (pitch up, approaching sound)
  - **CUMULATIVE:** Each repeat shifts pitch further (exponential growth)

- **feedback amplifies cumulative effects:**
  - Higher feedback = more repeats = more cumulative doppler + saturation
  - At +50% doppler with high feedback:
    - Repeat 1: +1 octave
    - Repeat 2: +2 octaves
    - Repeat 3: +3 octaves (eventually out of audible range)
  - Natural decay as pitch shifts out of hearing range

- **grainSize vs grainOverlap trade-off:**
  - Larger grainSize = smoother sound, more latency, less CPU per grain
  - Higher grainOverlap = smoother sound, more CPU (more simultaneous grains)
  - Recommended: grainSize=100ms, grainOverlap=4x for best quality

- **Bypass controls allow hybrid processing:**
  - bypassStereoWidth + bypassDoppler = delay + saturation only
  - bypassDelay = stereo width + saturation only (no delay/doppler)
  - bypassDoppler = stereo width + delay + saturation (no pitch shift)
  - bypassSaturation = stereo width + delay + doppler (no saturation)

### Processing Order Requirements

**Sequential processing order (REQUIRED):**

1. **Read input:** Store stereo input for stereo width processing
2. **Apply stereo width (Stage 1):**
   - Smooth stereoControl parameter (exponential smoothing)
   - Calculate L/R delay times with differential offsets
   - Process left/right channels through stereo delay lines
3. **Apply tape delay (Stage 2):**
   - Add filtered feedback to stereo width output
   - Write to delay line
   - Read delayed signal from delay line
4. **Apply granular pitch shifter (Stage 3):**
   - Calculate pitch ratio from dopplerShift
   - Process grains with variable-rate playback
   - Overlap-add grains for continuous output
   - Applied per-sample in feedback loop (CUMULATIVE)
5. **Apply saturation (Stage 4):**
   - Tanh waveshaping applied to pitch-shifted signal
   - Applied per-sample in feedback loop (CUMULATIVE)
6. **Apply feedback filtering:**
   - Lo-cut (highpass) filter
   - Hi-cut (lowpass) filter
   - Scale by feedback gain
   - Store in feedback buffer for next iteration
7. **Apply master output (Stage 5):**
   - Scale final output by masterOutput gain
8. **Write to output buffer:** Final stereo output

**Why order matters:**
- Stereo width must process before delay (spatial positioning preserved through feedback)
- Granular pitch shifter must be in feedback loop (creates cumulative doppler shift)
- Saturation must apply after pitch shifting (saturates the shifted signal)
- Filters must apply after saturation (tape frequency degradation on saturated signal)
- Master output is last (final gain staging)

### Thread Boundaries

**Threads:**
- **Audio thread:** All DSP processing in processBlock() - NO allocations, NO locks
- **Message thread:** Parameter updates, preset loading, UI interactions

**Audio thread operations:**
- All DSP processing (stereo width, delay, granular pitch shifting, saturation, filtering)
- Parameter reads via `APVTS::getRawParameterValue()->load()` (atomic)
- Sample-by-sample processing in processBlock()
- Granular grain buffer management (pre-allocated, no runtime allocations)

**Message thread operations:**
- Parameter updates from UI via APVTS (atomic writes)
- Preset loading/saving
- UI repaints

**No background thread needed:**
- No file I/O
- No long-running operations
- All processing is real-time compatible

**Communication:**
- APVTS parameters: Atomic reads (audio thread) / atomic writes (message thread)
- No custom thread communication needed (APVTS handles it)

---

## Implementation Risks

### Granular Pitch Shifting

**Complexity:** HIGH
- Grain buffer management (circular buffer with multiple read pointers)
- Overlap-add synthesis (4 simultaneous grains with windowing)
- Pitch-shifted grain playback (variable-rate resampling)
- Artifact minimization (grain boundary smoothing)
- Cumulative behavior in feedback loop (pitch shifts compound)

**Risk Level:** HIGH

**Risk factors:**
1. Granular synthesis is algorithmically complex
   - Multiple grain playback engines (4 overlapping grains)
   - Grain windowing and overlap-add math
   - Pitch-shifted playback requires interpolation
2. No existing JUCE granular class (custom implementation required)
3. CPU cost moderate to high (~20-40% single core depending on grain settings)
4. Artifacts possible (graininess, metallic sound if grain size/overlap incorrect)
5. Buffer management complexity (circular grain buffer + overlap tracking)
6. **Cumulative pitch shift may shift out of audible range quickly** (natural with high feedback)

**Mitigation strategy:**
1. Implement granular engine in isolation first (unit test pitch shift accuracy)
2. Start with 2-grain overlap (lower CPU), scale to 4-grain if CPU allows
3. Tune grain size (50-100ms range) to minimize artifacts
4. Reference existing granular implementations (JUCE forum examples)
5. Profile CPU usage early (may need quality modes: draft/standard/HQ)
6. Make grainSize and grainOverlap user-adjustable (advanced settings)
7. Test cumulative behavior thoroughly (verify pitch shifts compound correctly)

### Feedback Loop Stability with Cumulative Effects

**Complexity:** MEDIUM
- Cumulative doppler + saturation in feedback may cause unexpected behavior
- High feedback + high doppler may shift pitch out of audible range quickly
- Filters in feedback path may introduce phase shifts

**Risk Level:** MEDIUM

**Risk factors:**
1. Cumulative pitch shift grows exponentially (each repeat multiplies pitch ratio)
2. High feedback (>70%) with high doppler (>30%) may create rapid pitch escalation
3. Saturation in feedback may interact with pitch-shifted signal unpredictably
4. Filter resonance may cause instability at extreme settings

**Mitigation strategy:**
1. Clamp feedback gain to 0.95 maximum (5% safety margin)
2. Use IIR filters with moderate Q (avoid resonance peaks)
3. Test with extreme settings (feedback=95%, dopplerShift=+50%, saturation=+24dB)
4. Add soft clipper after saturation if runaway occurs (safety limiter)
5. Document expected cumulative behavior (pitch escalation is intentional)

### Stereo Width Smoothing

**Complexity:** LOW
- Exponential smoothing is straightforward
- No LFO modulation (simpler than previous revision)

**Risk Level:** LOW

**Risk factors:**
1. Parameter changes may cause clicks if not smoothed (10ms time constant mitigates)

**Mitigation strategy:**
1. Use exponential smoothing with 10ms time constant
2. Test with rapid parameter changes (verify no clicks)

### Overall Project Risk

**Overall complexity:** HIGH (5.0 maximum complexity)
- Stereo width (LOW) + tape delay (MEDIUM) + granular pitch shifting (HIGH) + saturation (LOW)
- Highest risk: Granular pitch shifting (70% of project risk)
- Second risk: Cumulative feedback behavior (20% of project risk)

**Highest risk component:** Granular Pitch Shifter
- Most algorithmically complex (grain management, overlap-add, windowing)
- No JUCE class (custom implementation)
- Artifact risk if grain size/overlap tuned incorrectly
- CPU cost significant (~20-40% single core)
- Cumulative behavior in feedback adds complexity

**Recommended approach:**
1. **Phase 1 - Validate concept:** Implement stereo width + basic delay (no feedback) (LOW risk)
2. **Phase 2 - Granular engine:** Implement granular pitch shifter in isolation (HIGH risk)
3. **Phase 3 - Integration:** Integrate granular into feedback loop (MEDIUM risk)
4. **Phase 4 - Saturation + filters:** Add saturation + filters to feedback (LOW risk)
5. **Phase 5 - Polish:** Tune grain parameters, optimize CPU, reduce artifacts

---

## Architecture Decisions

### Separate Stereo Width and Doppler Shift

**Decision:** Implement stereoWidth and dopplerShift as separate, independent parameters

**Rationale:**
- Stereo width = spatial positioning (L/R delay differential)
- Doppler shift = frequency shift (granular pitch shifting)
- These are conceptually distinct effects
- Users may want stereo width WITHOUT pitch shifting (or vice versa)
- Bypass controls allow independent enabling/disabling

**Alternatives considered:**
1. **Combined stereo width + doppler:**
   - Why rejected: Conflates spatial and frequency domains (confusing UX)
   - When to reconsider: Never (separation is clearer)

**Tradeoffs accepted:**
- **More parameters:** 2 parameters instead of 1
  - Acceptable because: Conceptual clarity outweighs UI simplicity
- **More complex implementation:** Two separate stages
  - Acceptable because: Implementation is still straightforward (stereo width is simple)

**When to revisit:**
- Never (separation is final design decision)

### Cumulative Doppler Shift in Feedback Loop

**Decision:** Place granular pitch shifter INSIDE feedback loop (cumulative pitch shift)

**Rationale:**
- Creates true doppler effect (pitch escalates/descends with each repeat)
- Simulates approaching/receding sound (pitch rises/falls consistently)
- Each repeat shifts pitch further (exponential growth matches physical doppler)
- Natural decay as pitch shifts out of audible range
- More dramatic and creative than fixed pitch shift

**Alternatives considered:**
1. **Pitch shift after feedback (constant pitch per repeat):**
   - Why rejected: Less dramatic, doesn't create escalating doppler effect
   - When to reconsider: If cumulative behavior proves too extreme (user feedback)

**Tradeoffs accepted:**
- **Rapid pitch escalation:** High feedback + high doppler creates extreme pitch shifts
  - Acceptable because: This is intentional creative effect (red/blue shift concept)
  - Users can reduce feedback or doppler for subtler effect
- **CPU cost per feedback iteration:** Granular processing on every repeat
  - Acceptable because: Granular engine is reasonably efficient (~20-30% CPU)

**When to revisit:**
- If users report cumulative behavior is too extreme (consider constant pitch mode)

### Granular Synthesis Over Phase Vocoder

**Decision:** Use granular synthesis (not phase vocoder) for pitch shifting

**Rationale:**
- Lower complexity than phase vocoder (FFT-based)
- Lower CPU cost (~20-30% vs ~40-60% for phase vocoder)
- Lower latency (~10-20ms vs ~42ms for phase vocoder)
- Acceptable quality for creative doppler effect (not transparent pitch correction)
- JUCE has DelayLine support (useful for granular implementation)
- Professional plugins use granular for creative pitch effects

**Alternatives considered:**
1. **Phase vocoder (FFT-based):**
   - Why rejected: Higher complexity, higher CPU, higher latency
   - When to reconsider: v2.0 if granular artifacts unacceptable

**Tradeoffs accepted:**
- **Granular artifacts:** May have slight graininess compared to phase vocoder
  - Acceptable because: Doppler effect is creative, not transparent
  - User-adjustable grainSize and grainOverlap allow artifact mitigation
- **Fixed pitch range:** ±1 octave (±12 semitones)
  - Acceptable because: Red shift concept is ±1 octave per repeat

**When to revisit:**
- If granular artifacts reported as unacceptable (upgrade to phase vocoder)
- If CPU usage exceeds 50% single core (optimize grain overlap or size)

### No LFO Modulation

**Decision:** Remove LFO modulation entirely (no lfoRate, lfoDepth, lfoTempoSync parameters)

**Rationale:**
- User requested removal (cleaner, more focused design)
- Stereo width is now static (spatial positioning, not time-varying)
- Granular doppler shift is unidirectional (not oscillating)
- Simpler implementation and UI
- Reduces parameter count from 18 to 15

**Alternatives considered:**
1. **Keep LFO for tape wow & flutter:**
   - Why rejected: User preference, cleaner design without it
   - When to reconsider: v2.0 if users request tape flutter effect

**Tradeoffs accepted:**
- **No tape wow & flutter:** Static stereo width, no pitch wobbling
  - Acceptable because: User preference, doppler shift provides pitch movement
- **Less "tape-like" character:** No LFO = no tape speed variation
  - Acceptable because: Focus is on doppler shift, not tape emulation

**When to revisit:**
- If users request tape wow & flutter (add LFO in v2.0)

---

## Special Considerations

### Thread Safety
- All parameter reads use atomic `getRawParameterValue()->load()` (real-time safe)
- Delay line buffers pre-allocated in prepareToPlay (no allocations in audio thread)
- Granular grain buffers pre-allocated in prepareToPlay (no reallocations)
- Feedback buffer sized for maximum delay (300ms at 192kHz)
- No shared state between channels (per-channel grain tracking)

### Performance
- **Stereo width:** ~5% CPU (two delay lines)
- **Tape delay:** ~5% CPU (delay line read/write + feedback mixing)
- **Granular pitch shifter:** ~20-40% CPU (depends on grainSize and grainOverlap)
  - 4-grain overlap, 100ms grain: ~30% CPU
  - 2-grain overlap, 100ms grain: ~15% CPU
- **Saturation:** ~3% CPU (per-sample tanh in feedback loop)
- **Feedback filters:** ~4% CPU (dual IIR filters)
- **Total estimated:** ~37-57% single core at 48kHz (depends on grain settings)
- **Optimization opportunities:**
  - Use 2x grain overlap instead of 4x (saves ~15% CPU)
  - Larger grain size (150-200ms) reduces CPU per grain
  - Bypass granular when dopplerShift = 0% (skip unnecessary processing)

### Denormal Protection
- Use `juce::ScopedNoDenormals` in processBlock()
- All JUCE DSP components handle denormals internally
- Granular grain buffer wrapping prevents denormals
- Delay line interpolation handles denormals (JUCE DelayLine internals)

### Sample Rate Handling
- Delay line buffer sized for maximum delay at 192kHz (57,600 samples for 300ms)
- Stereo width delay times scale with sample rate: `delaySamples = delayMs * (sampleRate / 1000.0)`
- Granular grain size scales with sample rate: `grainSizeSamples = grainSizeMs * (sampleRate / 1000.0)`
- All processing reinitialized in prepareToPlay() on sample rate change

### Latency
- Stereo width: ~0-260ms (user-controlled, NOT counted as latency)
- Tape delay: 0-300ms user-controlled (NOT counted as latency)
- Granular pitch shifter: ~10-20ms inherent latency (grain size)
- Saturation: 0ms (instantaneous waveshaping)
- **Total plugin latency: ~10-20ms** (granular grain size)
- Report via `setLatencySamples()` for host compensation

---

## Research References

### Professional Plugins

1. **Roland RE-201 Space Echo**
   - Tape saturation in feedback loop (cumulative warmth)
   - Dual-band filtering in feedback
   - Observed: Saturation applied during tape recording (feedback loop placement)

2. **FabFilter Timeless 3**
   - Time-stretching and pitch-shifting modes
   - Independent time/pitch manipulation
   - Observed: Granular approach for pitch shifting

3. **Soundtoys EchoBoy**
   - Multiple tape echo modes with saturation
   - Saturation and filtering in feedback path
   - Observed: Cumulative effects in feedback create character

4. **Eventide H3000**
   - Pitch shifting with feedback
   - Observed: Cumulative pitch shift creates unique sounds

### JUCE Documentation

- **juce::dsp::DelayLine<float, Linear>**: Variable delay with linear interpolation
- **juce::AudioPlayHead::getPosition()**: Get host playback position info
- **juce::dsp::ProcessSpec**: DSP component configuration
- **juce::AudioProcessorValueTreeState**: Parameter management

### Technical Resources

- **Granular Synthesis Literature:**
  - "Real-Time Granular Synthesis with Texture Control" (Curtis Roads)
  - Grain size: 50-100ms typical for pitch shifting
  - Overlap factor: 4x (75% overlap) for smooth output
  - Window function: Hann window

- **Pitch Shifting Mathematics:**
  - Pitch ratio formula: `ratio = 2^(semitones / 12)`
  - Cumulative pitch shift: Each repeat multiplies pitch ratio

- **Stereo Width (Haas Effect):**
  - Optimal delay differential: 1-40ms (precedence effect)
  - Extended range: 40-300ms (creates stereo width without precedence)
  - 260ms differential creates wide stereo imaging

---

## Notes

- Series architecture with cumulative feedback effects
- Stereo width and doppler shift are separate, independent effects
- Granular pitch shifter creates true unidirectional doppler (pitch rises/falls consistently)
- Cumulative doppler in feedback creates escalating pitch shift (exponential growth)
- Saturation in feedback loop creates cumulative tape warmth
- No LFO modulation (removed for cleaner, more focused design)
- Total estimated CPU: ~37-57% single core at 48kHz (depends on grain settings)
- Latency: ~10-20ms (granular grain size, report for host compensation)
- Advanced settings allow grain quality tuning (grainSize, grainOverlap)
- All state is parameter-based (APVTS automatic serialization)
