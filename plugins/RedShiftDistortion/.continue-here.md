---
plugin: RedShiftDistortion
stage: Stage 3 (GUI) - UI Visual Feedback Broken
status: ⚠️ CRITICAL - Knobs Don't Rotate Visually
last_updated: 2026-02-10
orchestration_mode: true
next_action: Rebuild WebView bridge from scratch - visual feedback completely broken
---

# RedShiftDistortion: UI Visual Feedback BROKEN

## Problem Statement

**Audio processing works perfectly** - all 7 parameters control DSP correctly:
- DOPPLER_SHIFT / "SHIFT" knob → Psychoacoustic shift works
- STEREO_WIDTH / "DELAY" knob → Delay time changes
- FEEDBACK knob → Feedback amount works
- SATURATION knob → Saturation works
- FILTER_BAND_LOW / "LO-CUT" → Filter works
- FILTER_BAND_HIGH / "HI-CUT" → Filter works
- MASTER_OUTPUT / "MASTER" → Output level works
- BYPASS_DOPPLER button → Toggles bypass
- BYPASS_SATURATION button → Toggles bypass

**BUT: Visual feedback is completely broken:**
- ❌ Knobs don't rotate when dragged (filmstrip doesn't update)
- ❌ Bypass buttons don't light up when clicked
- ❌ No visual response to interaction AT ALL
- ✅ Parameters DO change (confirmed via audio & DAW automation)
- ✅ Mouse interaction is detected (drag works)
- ✅ JavaScript executes (console logs show code running)

## Current Architecture (NOT WORKING)

### Layer 1: DSP Parameters (PluginProcessor.cpp)
```cpp
// 9 parameters defined in APVTS
juce::AudioParameterFloat("DOPPLER_SHIFT", ...)  // -50% to +50%
juce::AudioParameterFloat("STEREO_WIDTH", ...)   // -100% to +100%
// ... 5 more float params
juce::AudioParameterBool("BYPASS_DOPPLER", ...)
juce::AudioParameterBool("BYPASS_SATURATION", ...)
```
✅ **Working** - DSP reads parameters correctly, audio processing functions.

### Layer 2: C++ WebView Bridge (PluginEditor.cpp)
```cpp
// 1. Create relay
dopplerShiftRelay = std::make_unique<juce::WebSliderRelay>("DOPPLER_SHIFT");

// 2. Register with WebView
webView = std::make_unique<juce::WebBrowserComponent>(
    Options{}.withOptionsFrom(*dopplerShiftRelay)
);

// 3. Create attachment (binds parameter → relay)
dopplerShiftAttachment = std::make_unique<juce::WebSliderParameterAttachment>(
    *audioProcessor.parameters.getParameter("DOPPLER_SHIFT"),
    *dopplerShiftRelay,
    nullptr
);
```
❓ **Unknown** - Bridge exists, attachment created, but visual feedback doesn't work.

### Layer 3: HTML Element (index.html:359)
```html
<div class="main-knob" id="dopplerKnob" data-param="DOPPLER_SHIFT"></div>
```
✅ **Working** - Element exists, mouse events fire.

### Layer 4: JavaScript Bridge (index.html:510)
```javascript
const sliderState = getSliderState('DOPPLER_SHIFT');  // From JUCE bridge

// User drags knob
sliderState.setNormalisedValue(newValue);  // Sends to C++
updateFilmstrip(newValue);  // Updates visual (DOESN'T WORK)
```
❌ **BROKEN** - `updateFilmstrip()` called but visual doesn't update.

### Layer 5: Visual Feedback (Filmstrip Animation)
```javascript
function updateFilmstrip(normalizedValue) {
  const normalized = normalizedValue !== undefined
    ? normalizedValue
    : sliderState.getNormalisedValue();

  const frameIndex = Math.floor(normalized * 127);
  const yPosition = -(frameIndex * 176);

  element.style.backgroundPositionY = `${yPosition}px`;  // DOESN'T UPDATE
}
```
❌ **COMPLETELY BROKEN** - CSS property doesn't change visually.

## Debugging Attempts Made

### Attempt 1: Direct Value Passing
**Theory:** JUCE bridge might not update synchronously, read-back gets old value.
**Fix:** Pass calculated `newValue` directly to `updateFilmstrip(newValue)` instead of reading back.
**Result:** ❌ Still broken - visual doesn't update.

### Attempt 2: Immediate Visual Update in Handler
**Theory:** Waiting for event callback causes lag.
**Fix:** Call `updateFilmstrip()` immediately in `mousemove` handler.
**Result:** ❌ Still broken - visual doesn't update.

### Attempt 3: APVTS-Based Attachment Constructor
**Theory:** Different constructor might have better synchronization.
**Fix:** Use `WebSliderParameterAttachment(apvts, paramID, relay, nullptr)` instead of `WebSliderParameterAttachment(param*, relay, nullptr)`.
**Result:** ❌ Constructor doesn't exist in JUCE 8 - compilation error.

## Investigation Checklist

**Confirmed Working:**
- ✅ Parameters exist in APVTS
- ✅ Relays created successfully
- ✅ Attachments created successfully
- ✅ WebView initialized
- ✅ HTML loads correctly
- ✅ JavaScript executes
- ✅ Mouse events fire (mousedown, mousemove, mouseup)
- ✅ `getSliderState()` returns valid object
- ✅ `setNormalisedValue()` changes DSP parameter (audio proves it)
- ✅ `updateFilmstrip()` function is called

**Not Working:**
- ❌ `element.style.backgroundPositionY` doesn't visually update
- ❌ Knob graphic doesn't rotate
- ❌ Bypass button CSS classes don't apply (`element.classList.toggle()`)
- ❌ No visual feedback whatsoever

**Not Tested:**
- ❓ Does WebView console show errors? (Check browser developer tools if possible)
- ❓ Does `console.log(element.style.backgroundPositionY)` show value changing?
- ❓ Does CSS property exist? (Check computed styles)
- ❓ Is WebView rendering at all? (Try changing background color via JS)
- ❓ Are filmstrip images loading? (Check network tab / resource loading)

## Root Cause Hypotheses

### Hypothesis 1: WebView Rendering Engine Issue
**Theory:** JUCE's WebView on macOS might have CSS rendering bugs with `background-position`.
**Test:** Try using `transform: rotate()` instead of filmstrip animation.
**Evidence:** All JavaScript executes, but NO visual changes happen.

### Hypothesis 2: Z-Index / Layering Problem
**Theory:** Knob elements might be behind other layers (glows).
**Test:** Inspect DOM, check z-index values, try removing glow layers.
**Evidence:** Mouse events work, so layer is clickable.

### Hypothesis 3: CSS Specificity / !important Override
**Theory:** CSS might be overridden somewhere.
**Test:** Add `!important` to background-position changes.
**Evidence:** Unlikely - other CSS works fine (layout, colors).

### Hypothesis 4: JavaScript Execution Context
**Theory:** JUCE bridge might be running in different JavaScript context.
**Test:** Check if `element` is the same object bridge sees.
**Evidence:** `getSliderState()` works, so bridge is connected.

### Hypothesis 5: Image Resources Not Loading
**Theory:** Filmstrip images might not be loaded properly.
**Test:** Check BinaryData includes images, verify getResource() returns correct data.
**Evidence:** Static background image shows, so resource system works partially.

## Rebuild Strategy (Next Steps)

### Phase 1: Verify Basic WebView Rendering
1. Add test button that changes background color via JavaScript
2. Verify DOM manipulation works AT ALL in WebView
3. If this fails → WebView is fundamentally broken

### Phase 2: Simplify Visual Feedback (Remove Filmstrip)
1. Replace filmstrip with simple CSS `transform: rotate()`
2. Calculate rotation angle from parameter value
3. Test if rotation works (eliminates filmstrip complexity)
4. If this works → Filmstrip is the problem
5. If this fails → CSS rendering is broken

### Phase 3: Alternative Rendering Approach
**Option A: Use JUCE Native Components**
- Remove WebView entirely
- Use `juce::Slider` with custom LookAndFeel
- Guarantee visual feedback works
- Lose custom HTML/CSS flexibility

**Option B: Debug WebView Step-by-Step**
- Add extensive console logging
- Log every style change
- Check computed styles after each change
- Use WebView inspector if available

**Option C: Hybrid Approach**
- Keep WebView for layout/graphics
- Use invisible native sliders for interaction
- Sync visual updates via timer polling parameter values

## Files Involved

**C++ Bridge:**
- `Source/PluginEditor.h` (lines 21-50) - Relay/attachment declarations
- `Source/PluginEditor.cpp` (lines 15-59) - Relay/attachment creation
- `Source/PluginProcessor.cpp` (lines 48-89) - Parameter definitions

**UI:**
- `Source/ui/public/index.html` (lines 355-411) - Knob HTML elements
- `Source/ui/public/index.html` (lines 457-507) - setupHISEFilmstripKnob function
- `Source/ui/public/index.html` (lines 509-518) - Knob initialization calls
- `Source/ui/public/index.html` (lines 119-131) - Knob CSS (filmstrip background)

**Assets:**
- `Source/ui/public/assets/hise_knob_big.png` - Main knob filmstrip (176px × 22,528px)
- `Source/ui/public/assets/hise_knob_small.png` - Sub knobs filmstrip (65px × 8,320px)

## Success Criteria

For visual feedback to be considered "working":

1. **Knobs rotate smoothly** when dragged with mouse
2. **Bypass buttons light up** (red) when clicked/active
3. **Visual updates happen immediately** during interaction (< 16ms latency)
4. **DAW automation** causes visual updates (knobs follow automation)
5. **Parameter changes** from any source reflect visually

Currently: **0 of 5 criteria met** ❌

---

**Priority:** CRITICAL - Plugin is functionally complete but unusable without visual feedback.
**Estimated Effort:** 4-8 hours (depends on root cause)
**Risk:** High - May need to abandon WebView approach entirely
