---
plugin: RedShiftDistortion
stage: 1
phase: null
status: complete
last_updated: 2026-02-08
complexity_score: 5.0
phased_implementation: true
orchestration_mode: true
next_action: invoke_dsp_agent
next_phase: 2.1
contract_checksums:
  creative_brief: sha256:pending
  parameter_spec: sha256:pending
  architecture: sha256:pending
  plan: sha256:pending
---

# Resume Point

## Current State: Stage 1 Complete - Foundation + Shell Implemented

Build system configured with 13 APVTS parameters (7 main + 4 bypass + 2 advanced). All files created and ready for Stage 2 DSP implementation (5 phases).

**ARCHITECTURE:** Stereo Width + Cumulative Granular Doppler in Feedback Loop
**Signal Flow:** Input → Stereo Width → Tape Delay (with Feedback: Granular Doppler → Saturation → Filters) → Master Output

## Completed So Far

**Ideation:** ✓ Complete
- Core concept defined: Series tape delay with separated stereo width modulation and cumulative granular doppler shift
- Creative brief finalized (2026-02-08)
- Architecture completely rewritten for final design

**Stage 0:** ✓ Complete (Finalized 2026-02-08)
- Plugin type defined: Audio Effect (Tape Delay with Cumulative Doppler)
- Professional examples researched: FabFilter Timeless 3, Eventide H3000, Roland RE-201 Space Echo
- JUCE modules identified: juce::dsp::DelayLine, juce::dsp::IIR (filters), std::tanh (saturation)
- DSP feasibility verified: Series chain with granular pitch shifting in feedback loop
- **Complexity score: 5.0** (Maximum - granular pitch shifting with cumulative feedback)
- Strategy: Phased implementation (5 DSP phases, granular engine isolated testing)
- Architecture documented: Separated stereo width + cumulative doppler + saturation
- Plan documented: 6-9 day implementation timeline

**Stage 1:** ✓ Complete (2026-02-08)
- Build system operational (CMakeLists.txt configured with JUCE 8 patterns)
- APVTS parameter layout created with 13 parameters
- PluginProcessor.h/cpp created with stereo effect bus configuration
- PluginEditor.h/cpp created with placeholder UI
- All parameter IDs use SCREAMING_SNAKE_CASE
- State persistence implemented (getStateInformation/setStateInformation)
- Pass-through audio processing (DSP to be added in Stage 2)

## Architecture Summary (Implemented in Stage 1)

### Processing Chain (Series with Cumulative Feedback)

```
Input (Stereo)
  ↓
STAGE 1: Stereo Width Modulation
  - Differential L/R delay times (±260ms max)
  - Static spatial positioning (no LFO)
  - Bypass: BYPASS_STEREO_WIDTH
  ↓
STAGE 2: Tape Delay (with Cumulative Feedback Loop)
  - Delay line (300ms max)
  - Feedback loop contains (in order):
    → STAGE 3: Granular Pitch Shifter (CUMULATIVE doppler)
       - 4-grain overlap (or 2x for lower CPU)
       - Hann windowing
       - Variable-rate grain playback
       - Bypass: BYPASS_DOPPLER
    → STAGE 4: Saturation (CUMULATIVE warmth)
       - Tanh waveshaping
       - Bypass: BYPASS_SATURATION
    → Hi-cut filter (lowpass)
    → Lo-cut filter (highpass)
    → Feedback gain
  - Bypass: BYPASS_DELAY
  ↓
STAGE 5: Master Output
  - Final gain staging
  ↓
Output (Stereo)
```

### Parameters (Implemented - 13 total)

**Main Controls (7 parameters - FloatParameters)**
1. `STEREO_WIDTH` (Float, -100.0 to 100.0%, default: 0.0%) - Spatial positioning via L/R delay differential
2. `FEEDBACK` (Float, 0.0 to 95.0%, default: 0.0%) - Feedback gain
3. `FILTER_BAND_LOW` (Float, 20.0 to 20000.0 Hz, default: 100.0 Hz) - Highpass cutoff in feedback
4. `FILTER_BAND_HIGH` (Float, 20.0 to 20000.0 Hz, default: 8000.0 Hz) - Lowpass cutoff in feedback
5. `DOPPLER_SHIFT` (Float, -50.0 to 50.0%, default: 0.0%) - Pitch shift per repeat (±12 semitones, **CUMULATIVE**)
6. `SATURATION` (Float, -12.0 to 24.0 dB, default: 0.0 dB) - Tube drive amount (**CUMULATIVE** in feedback)
7. `MASTER_OUTPUT` (Float, -60.0 to 12.0 dB, default: 0.0 dB) - Final output level

**Bypass Controls (4 parameters - BoolParameters)**
8. `BYPASS_STEREO_WIDTH` (Bool, default: false) - Bypass stereo width modulation
9. `BYPASS_DELAY` (Bool, default: false) - Bypass entire delay + feedback loop
10. `BYPASS_DOPPLER` (Bool, default: false) - Bypass granular pitch shifting
11. `BYPASS_SATURATION` (Bool, default: false) - Bypass saturation stage

**Advanced Settings (2 parameters - 1 Float + 1 Choice)**
12. `GRAIN_SIZE` (Float, 25.0 to 200.0 ms, default: 100.0 ms) - Grain buffer size (quality vs CPU)
13. `GRAIN_OVERLAP` (Choice, "2x" or "4x", default: "4x") - Simultaneous grains (2x = lower CPU, 4x = smoother)

**Key Concepts:**
- **STEREO_WIDTH** (spatial) and **DOPPLER_SHIFT** (pitch) are separate, independent effects
- **Cumulative doppler:** Each feedback repeat applies another pitch shift (exponential growth)
  - Example: +50% doppler → Repeat 1: +1 octave, Repeat 2: +2 octaves, Repeat 3: +3 octaves
- **Cumulative saturation:** Each repeat gets progressively more saturated (authentic tape echo)
- **No LFO modulation:** Removed for cleaner, more focused design

## Next Steps

**Stage 2 (DSP - 5 Phases, 6-9 days total):**

**Phase 2.1: Stereo Width + Basic Delay (1 day)**
- Implement stereo width modulation (differential L/R delays with exponential smoothing)
- Implement basic delay line (no feedback yet, just pass-through)
- Implement master output gain
- Test bypass controls (BYPASS_STEREO_WIDTH, BYPASS_DELAY placeholders)
- Verify pass-through audio works
- No clicks, pops, or artifacts

**Phase 2.2: Granular Pitch Shifter (3-5 days) ⚠️ HIGHEST RISK**
- Implement granular synthesis engine in isolation
- Grain buffer management (circular buffer)
- Hann window generation (pre-calculated lookup table)
- Grain spawning and overlap tracking (4-grain or 2-grain overlap)
- Variable-rate grain playback (pitch-shifted resampling)
- Overlap-add synthesis (sum of windowed grains)
- Test pitch shift accuracy with tone generator (440 Hz → 880 Hz at +50% doppler)
- Test grain boundaries are smooth (no clicks/pops)
- Test GRAIN_SIZE and GRAIN_OVERLAP parameters

**Phase 2.3: Integrate Granular into Feedback Loop (1 day)**
- Add feedback loop structure (delayed signal fed back to input)
- Place granular pitch shifter in feedback path
- Test cumulative behavior (each repeat shifts pitch further)
- Test stability at extreme settings (feedback=95%, doppler=+50%)

**Phase 2.4: Saturation + Filters in Feedback (1 day)**
- Add tube saturation (tanh waveshaping AFTER granular pitch shifter)
- Add hi-cut filter (lowpass) in feedback path
- Add lo-cut filter (highpass) in feedback path
- Test cumulative saturation builds with each repeat
- Test filters create tape echo frequency response

**Phase 2.5: Polish and Optimization (0.5-1 day)**
- Tune grain parameters for quality/CPU balance
- CPU profiling and optimization
- Artifact reduction (tune grain size and overlap)
- Bypass optimization (skip unnecessary processing when bypassed)

**Stage 3 (GUI - 1 day):**
- Update UI for 13 parameters
- Add advanced settings panel (collapsible)
- Bind all parameters via WebSliderRelay/WebToggleButtonRelay

**Stage 4 (Validation - 1 day):**
- Create 10 presets showcasing cumulative doppler + stereo width
- Run pluginval testing
- Build and install

## Context to Preserve

**Key Architecture Decisions:**
- **Separated stereo width and doppler shift:** Conceptually distinct effects (spatial vs frequency)
- **Cumulative doppler in feedback loop:** Creates true unidirectional pitch shift (approaching/receding sound)
  - Pitch escalates/descends with each repeat (exponential growth)
  - Eventually shifts out of audible range (natural decay)
  - NOT oscillating wow & flutter (that would bounce up and down)
- **Granular synthesis for pitch shifting:** Lower CPU than phase vocoder, acceptable quality for creative effect
- **Saturation after granular in feedback:** Saturates the pitch-shifted signal, cumulative warmth
- **No LFO modulation:** Removed for cleaner design (doppler provides pitch movement)
- **Advanced settings:** Grain size and overlap exposed for quality tuning
- **Complexity tier:** 5.0 (Maximum - granular pitch shifting is highest complexity)

**Implementation Strategy:**
- Stage 2 (DSP): 5 phases (6-9 days total)
  - Phase 2.2 is CRITICAL PATH (granular engine, 3-5 days, 70% of project risk)
  - Implement granular in isolation first (unit test before feedback integration)
  - Test cumulative behavior thoroughly (verify pitch compounds correctly)
- Stage 3 (GUI): 1 day (update UI for 13 parameters, add collapsible advanced panel)

**Highest Risk Component:**
- Granular pitch shifter (70% of project risk)
- Most algorithmically complex (grain management, overlap-add, windowing, variable-rate playback)
- No JUCE class (custom implementation required)
- CPU cost significant (~20-40% single core depending on grain settings)
- Cumulative behavior adds testing complexity

**Mitigation Strategy:**
- Implement granular engine in isolation first
- Unit test pitch accuracy with tone generator (440 Hz → 880 Hz at +50% doppler)
- Profile CPU early and optimize if >50% single core
- Start with 2-grain overlap (simpler), scale to 4-grain if CPU allows
- Make grain settings user-adjustable (allows post-release tuning)
- Reference Curtis Roads granular synthesis literature

**Files Created (Stage 1):**
- plugins/RedShiftDistortion/CMakeLists.txt (✓ CREATED 2026-02-08)
- plugins/RedShiftDistortion/Source/PluginProcessor.h (✓ CREATED 2026-02-08)
- plugins/RedShiftDistortion/Source/PluginProcessor.cpp (✓ CREATED 2026-02-08)
- plugins/RedShiftDistortion/Source/PluginEditor.h (✓ CREATED 2026-02-08)
- plugins/RedShiftDistortion/Source/PluginEditor.cpp (✓ CREATED 2026-02-08)

**Contract Files (Stage 0):**
- plugins/RedShiftDistortion/.ideas/creative-brief.md (✓ FINALIZED 2026-02-08)
- plugins/RedShiftDistortion/.ideas/architecture.md (✓ FINALIZED 2026-02-08)
- plugins/RedShiftDistortion/.ideas/plan.md (✓ FINALIZED 2026-02-08)
- plugins/RedShiftDistortion/.ideas/parameter-spec.md (✓ FINALIZED 2026-02-08)

## Implementation Notes

**CRITICAL JUCE 8 Patterns Used:**
- Pattern #1: `juce_generate_juce_header()` called after `target_link_libraries()`
- Pattern #2: Prefer module headers (`<juce_audio_processors/juce_audio_processors.h>`)
- Pattern #4: Stereo effect bus configuration (input + output)
- Pattern #9: `NEEDS_WEB_BROWSER TRUE` for VST3 WebView support
- ParameterID format: `juce::ParameterID { "ID", 1 }` (JUCE 8 requirement)
- APVTS initialization: `parameters(*this, nullptr, "Parameters", createParameterLayout())`
- State persistence: `getStateInformation()` and `setStateInformation()` implemented

**Parameter Count Verification:**
- **Total:** 13 parameters (7 main + 4 bypass + 2 advanced)
- **Main:** STEREO_WIDTH, FEEDBACK, FILTER_BAND_LOW, FILTER_BAND_HIGH, DOPPLER_SHIFT, SATURATION, MASTER_OUTPUT
- **Bypass:** BYPASS_STEREO_WIDTH, BYPASS_DELAY, BYPASS_DOPPLER, BYPASS_SATURATION
- **Advanced:** GRAIN_SIZE, GRAIN_OVERLAP

**Deleted Parameters (from previous revisions - NOT in current implementation):**
- ~~`lfoRate`~~ - No LFO modulation
- ~~`lfoDepth`~~ - No LFO modulation
- ~~`lfoTempoSync`~~ - No LFO modulation
- ~~`delayLevel`~~ - No parallel mixing
- ~~`distortionLevel`~~ - No parallel mixing
- ~~`pitchEnable`~~ - Removed
- ~~`delayTime`~~ - Stereo width is fixed at 260ms
- ~~`tempoSync`~~ - Removed
- ~~`reverse`~~ - Removed

**Expected Behavior:**
- Cumulative doppler creates escalating pitch shifts (intentional, not a bug)
- High feedback + high doppler may shift pitch out of audible range quickly (natural decay)
- Stereo width is static (no time-varying modulation)
- Doppler shift is unidirectional (pitch consistently rises or falls, does NOT oscillate)

**Performance Targets:**
- CPU usage: 37-57% single core at 48kHz (depends on grain settings)
- Latency: ~10-20ms (granular grain size, report for host compensation)
- No clicks, pops, or artifacts at default settings (100ms grain, 4x overlap)
- Acceptable artifacts at extreme settings (25ms grain may have slight graininess, documented)
