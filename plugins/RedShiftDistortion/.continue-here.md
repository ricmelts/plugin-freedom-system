---
plugin: RedShiftDistortion
stage: Stage 3 Complete - DSP Fully Implemented
status: ✅ Ready for Final Testing & Polish
last_updated: 2026-02-10
orchestration_mode: true
next_action: Comprehensive testing in DAW, adjust parameters if needed
---

# RedShiftDistortion: COMPLETE ✅

## DSP Implementation Complete (2026-02-10 - Session 2)

All DSP processing implemented and tested:

### Signal Chain Implemented:
1. **Stage 1: Psychoacoustic Shift** - ITD-based delay using DOPPLER_SHIFT parameter (-50% to +50%)
   - Left/right channels delayed in opposite directions
   - Maximum ITD offset: 260ms
   - Smoothed parameter changes (10ms time constant)

2. **Stage 2: Tape Delay** - Variable delay using STEREO_WIDTH parameter (0-16000ms)
   - Independent left/right delay lines
   - Feedback loop with FEEDBACK parameter (0-95%)

3. **Stage 3: Saturation** - Soft-clipping waveshaping using SATURATION parameter (-12dB to +24dB)
   - Tanh saturation for smooth harmonic distortion
   - BYPASS_SATURATION toggle

4. **Stage 4: Feedback Filtering** - Hi-cut and Lo-cut filters in feedback path
   - Lo-cut (highpass): FILTER_BAND_LOW (20Hz - 20kHz)
   - Hi-cut (lowpass): FILTER_BAND_HIGH (20Hz - 20kHz)
   - Applied to feedback signal before return to delay input

5. **Stage 5: Master Output** - Final gain stage using MASTER_OUTPUT parameter (-60dB to +12dB)

### Files Modified:
- ✅ `Source/PluginProcessor.h` - Added filter state, feedback history, separate L/R delay lines
- ✅ `Source/PluginProcessor.cpp` - Implemented full 5-stage signal chain in processBlock
- ✅ Built and tested successfully in Standalone mode

---

## Parameter Remapping Complete (2026-02-10 - Session 1)

All 7 phases of parameter remapping executed successfully:

1. **Phase 1-2**: PluginProcessor.cpp already clean (9 parameters: 7 float + 2 bool)
2. **Phase 3**: HTML cleanup already complete (no grain controls, only 2 bypass buttons)
3. **Phase 4**: UI labels already correct (SHIFT, DELAY, SATURATION, MASTER, LO-CUT, HI-CUT, FEEDBACK)
4. **Phase 5**: ✅ Fixed JavaScript bindings (3 knobs remapped correctly)
5. **Phase 6**: ✅ Removed unused relays/attachments from PluginEditor.h/.cpp
6. **Phase 7**: ✅ Rebuilt successfully, Standalone launched for testing

## Current Parameter Configuration

**7 Float Parameters (Knobs):**
- DOPPLER_SHIFT → "SHIFT" (main center knob)
- STEREO_WIDTH → "DELAY" (top-left)
- SATURATION → "SATURATION" (top-center)
- MASTER_OUTPUT → "MASTER" (top-right)
- FILTER_BAND_LOW → "LO-CUT" (bottom-left)
- FILTER_BAND_HIGH → "HI-CUT" (bottom-center)
- FEEDBACK → "FEEDBACK" (bottom-right)

**2 Bool Parameters (Bypass Buttons):**
- BYPASS_DOPPLER → "Shift"
- BYPASS_SATURATION → "Saturation"

## Files Modified

- ✅ `Source/ui/public/index.html` - Fixed 3 JavaScript binding mismatches
- ✅ `Source/PluginEditor.h` - Removed 4 unused relays, 4 unused attachments
- ✅ `Source/PluginEditor.cpp` - Removed 4 unused relay creations, 4 unused attachment creations

## Next Steps

**DSP Implementation Needed:**
- Currently only STEREO_WIDTH (shift effect) and MASTER_OUTPUT are implemented
- Need to implement:
  - DOPPLER_SHIFT psychoacoustic shift (ITD-based delay with percentage control)
  - Delay line with FEEDBACK loop
  - SATURATION waveshaping with BYPASS_SATURATION
  - Hi-cut and Lo-cut filters in feedback path
  - Proper signal chain integration

---

# Original Planning Document Below (for reference)

## Architecture Overview
**Main Effect:** Psychoacoustic "shift" (ITD-based delay - signal in one ear, original in other, shifted by ITD + %)

**Signal Chain:** Input → Shift → Delay → Saturation → Feedback Loop (with Hi-Cut/Lo-Cut filters) → Master Output

## Target Parameter Configuration

### 7 Float Parameters (Knobs):
1. **DOPPLER_SHIFT** → UI Label: "SHIFT" (main center knob) - Psychoacoustic shift amount
2. **STEREO_WIDTH** → UI Label: "DELAY" (top-left) - Delay time/amount
3. **SATURATION** → UI Label: "SATURATION" (top-center) - Saturation drive
4. **MASTER_OUTPUT** → UI Label: "MASTER" (top-right) - Output level
5. **FILTER_BAND_LOW** → UI Label: "LO-CUT" (bottom-left) - Highpass filter
6. **FILTER_BAND_HIGH** → UI Label: "HI-CUT" (bottom-center) - Lowpass filter
7. **FEEDBACK** → UI Label: "FEEDBACK" (bottom-right) - Feedback amount

### 2 Bool Parameters (Bypass Buttons):
1. **BYPASS_SATURATION** → UI Label: "Saturation"
2. **BYPASS_DOPPLER** → UI Label: "Shift"

### Parameters to REMOVE:
- GRAIN_SIZE (no longer needed)
- GRAIN_OVERLAP (no longer needed)
- BYPASS_STEREO_WIDTH (consolidating bypasses)
- BYPASS_DELAY (consolidating bypasses)

---

## Execution Plan

### **Phase 1: Remove Unused Parameters from DSP**
**File:** `PluginProcessor.cpp`

1. Delete GRAIN_SIZE definition (lines 107-114)
2. Delete GRAIN_OVERLAP definition (lines 116-122)
3. Delete BYPASS_STEREO_WIDTH definition (lines 77-82)
4. Delete BYPASS_DELAY definition (lines 84-89)
5. Result: 7 float + 2 bool = **9 parameters total**

### **Phase 2: Update DSP processBlock to USE All Parameters**
**File:** `PluginProcessor.cpp` (processBlock method)

Currently only reads 4 parameters. Add reads for:
```cpp
const float dopplerShift = parameters.getRawParameterValue("DOPPLER_SHIFT")->load();
const float feedback = parameters.getRawParameterValue("FEEDBACK")->load();
const float saturation = parameters.getRawParameterValue("SATURATION")->load();
const float filterLow = parameters.getRawParameterValue("FILTER_BAND_LOW")->load();
const float filterHigh = parameters.getRawParameterValue("FILTER_BAND_HIGH")->load();
const bool bypassDoppler = parameters.getRawParameterValue("BYPASS_DOPPLER")->load() > 0.5f;
const bool bypassSaturation = parameters.getRawParameterValue("BYPASS_SATURATION")->load() > 0.5f;
```

Implement psychoacoustic shift using DOPPLER_SHIFT parameter (ITD-based delay with percentage control).

### **Phase 3: Update UI HTML - Remove Unused Controls**
**File:** `index.html`

1. **Delete grain controls:**
   - Lines 442-443: Grain Size slider
   - Lines 445-449: Grain Overlap dropdown
   - Lines 571-601: Grain JavaScript bindings

2. **Delete 2 bypass buttons:**
   - Lines 427-432: bypassFilters button (was BYPASS_STEREO_WIDTH)
   - Lines 434-439: bypassFeedback button (was BYPASS_DELAY)

3. **Keep only 2 bypass buttons:**
   - bypassDoppler → Rename label to "Shift"
   - bypassSaturation → Keep label as "Saturation"

### **Phase 4: Update UI HTML - Rename Knob Labels**
**File:** `index.html`

1. **Main knob (center):** Already bound to DOPPLER_SHIFT
   - Add label: "SHIFT" (currently no label shown)

2. **Top-left knob:** Currently STEREO_WIDTH → "stereo width"
   - Change label to: "DELAY"

3. **Top-center knob:** Currently FEEDBACK → "feedback"
   - Change label to: "SATURATION"
   - Change data-param to: "SATURATION"

4. **Top-right knob:** Currently MASTER_OUTPUT → "master" ✓ (correct)

5. **Bottom-left knob:** Currently FILTER_BAND_LOW → "lo-cut" ✓ (correct)

6. **Bottom-center knob:** Currently SATURATION → "saturation"
   - Change label to: "HI-CUT"
   - Change data-param to: "FILTER_BAND_HIGH"

7. **Bottom-right knob:** Currently FILTER_BAND_HIGH → "hi-cut"
   - Change label to: "FEEDBACK"
   - Change data-param to: "FEEDBACK"

### **Phase 5: Update JavaScript Bindings**
**File:** `index.html` (JavaScript section)

Update setupHISEFilmstripKnob calls to match new parameter mappings:
```javascript
// Main knob (center) - already correct
setupHISEFilmstripKnob(document.getElementById('dopplerKnob'), 'DOPPLER_SHIFT', 176);

// Top-left: delay (was stereoWidth)
setupHISEFilmstripKnob(document.getElementById('stereoWidthKnob'), 'STEREO_WIDTH', 65);

// Top-center: saturation (was feedback)
setupHISEFilmstripKnob(document.getElementById('feedbackKnob'), 'SATURATION', 65);

// Top-right: master - already correct
setupHISEFilmstripKnob(document.getElementById('masterOutputKnob'), 'MASTER_OUTPUT', 65);

// Bottom-left: lo-cut - already correct
setupHISEFilmstripKnob(document.getElementById('loCutKnob'), 'FILTER_BAND_LOW', 65);

// Bottom-center: hi-cut (was saturation)
setupHISEFilmstripKnob(document.getElementById('saturationKnob'), 'FILTER_BAND_HIGH', 65);

// Bottom-right: feedback (was hi-cut)
setupHISEFilmstripKnob(document.getElementById('hiCutKnob'), 'FEEDBACK', 65);
```

Update bypass button bindings:
```javascript
// Keep only 2 bypasses
setupBypassButton(document.getElementById('bypassDoppler'), 'BYPASS_DOPPLER'); // "Shift"
setupBypassButton(document.getElementById('bypassSaturation'), 'BYPASS_SATURATION'); // "Saturation"

// Remove these calls:
// setupBypassButton(document.getElementById('bypassFilters'), 'BYPASS_STEREO_WIDTH');
// setupBypassButton(document.getElementById('bypassFeedback'), 'BYPASS_DELAY');
```

### **Phase 6: Update PluginEditor - Remove Unused Relays**
**File:** `PluginEditor.h` & `PluginEditor.cpp`

Remove from header declarations:
- grainSizeRelay
- grainOverlapRelay
- bypassStereoWidthRelay
- bypassDelayRelay
- grainSizeAttachment
- grainOverlapAttachment
- bypassStereoWidthAttachment
- bypassDelayAttachment

Remove from constructor initialization (PluginEditor.cpp):
- All grain relay/attachment creation
- BYPASS_STEREO_WIDTH relay/attachment creation
- BYPASS_DELAY relay/attachment creation

### **Phase 7: Rebuild & Test**
1. Clean build: `./scripts/build-and-install.sh RedShiftDistortion --reconfigure`
2. Verify 9 parameters compile correctly
3. Test all 7 knobs respond to mouse drag
4. Test 2 bypass buttons toggle correctly
5. Verify parameter labels match knob functions
6. Verify DSP actually processes all parameters

---

## Parameter Binding Verification Matrix

| UI Knob Position | HTML ID | data-param | DSP Parameter | UI Label |
|------------------|---------|------------|---------------|----------|
| Center (main) | dopplerKnob | DOPPLER_SHIFT | DOPPLER_SHIFT | "SHIFT" |
| Top-left | stereoWidthKnob | STEREO_WIDTH | STEREO_WIDTH | "DELAY" |
| Top-center | feedbackKnob | **SATURATION** | SATURATION | "SATURATION" |
| Top-right | masterOutputKnob | MASTER_OUTPUT | MASTER_OUTPUT | "MASTER" |
| Bottom-left | loCutKnob | FILTER_BAND_LOW | FILTER_BAND_LOW | "LO-CUT" |
| Bottom-center | saturationKnob | **FILTER_BAND_HIGH** | FILTER_BAND_HIGH | "HI-CUT" |
| Bottom-right | hiCutKnob | **FEEDBACK** | FEEDBACK | "FEEDBACK" |

| UI Button | HTML ID | data-param | DSP Parameter | UI Label |
|-----------|---------|------------|---------------|----------|
| Button 1 | bypassDoppler | BYPASS_DOPPLER | BYPASS_DOPPLER | "Shift" |
| Button 2 | bypassSaturation | BYPASS_SATURATION | BYPASS_SATURATION | "Saturation" |

---

## Success Criteria
✅ 9 parameters total (7 float + 2 bool)
✅ All knob labels match their actual function
✅ DSP reads and uses all 7 float parameters
✅ Only 2 bypass buttons remain
✅ No grain controls visible
✅ Plugin compiles without errors
✅ All controls responsive in DAW

---

**Status:** Ready for execution
**Estimated Time:** 30-45 minutes
**Risk Level:** Low (pure refactoring, no new features)
