---
plugin: RedShiftDistortion
stage: Stage 3 (GUI) - Bug Fixes Required
status: üêõ Critical Issues - UI Non-Functional
last_updated: 2026-02-09
orchestration_mode: true
next_action: Fix UI parameter bindings + Revert DSP pitch issue
---

## Current State

**UI Status:** v10 implementation complete but **NON-FUNCTIONAL**
- Build successful: VST3, AU, Standalone all compile
- Visual design perfect: HISE filmstrip knobs, scaled main knob, centered labels
- **CRITICAL BUG:** None of the knobs are responding to user input
- Plugin loads but parameters are not controllable

**Installation:**
- VST3: `~/Library/Audio/Plug-Ins/VST3/RedShiftDistortion.vst3`
- AU: `~/Library/Audio/Plug-Ins/Components/RedShiftDistortion.component`
- Standalone app opens but UI is frozen/non-responsive

## Critical Issues to Fix

### Issue #1: UI Controls Not Working (CRITICAL)
**Symptom:** None of the knobs respond when clicked/dragged
**Likely Cause:** JUCE parameter binding broken during v10 conversion
**Evidence:**
- Filmstrip rendering implemented (visual frames)
- JavaScript `setupHISEFilmstripKnob()` function defined
- JUCE integration may not be properly connected

**Investigation Required:**
1. Check if JUCE WebView bridge is loading (`js/juce/index.js`)
2. Verify `getSliderState()`, `getToggleState()`, `getComboBoxState()` are accessible
3. Inspect browser console for JavaScript errors
4. Confirm parameter relay attachments in `PluginEditor.cpp` constructor

**Files to Check:**
- `Source/ui/public/index.html` - JavaScript integration (lines 477-531)
- `Source/PluginEditor.cpp` - Relay creation and attachments (lines 14-76)
- `Source/ui/public/js/juce/index.js` - WebView bridge functions

### Issue #2: DSP "Weird Pitch Thingy" (CRITICAL)
**Symptom:** DSP is doing unexpected pitch processing
**User Request:** Revert to version BEFORE the pitch issue was introduced
**Constraint:** Keep v10 UI exactly as-is (do not modify any UI code)

**Investigation Required:**
1. Review git history to find when pitch issue was introduced
2. Identify which DSP changes caused the problem
3. Revert only the DSP code (`Source/PluginProcessor.cpp`)
4. Keep all UI code untouched (`Source/ui/`, `CMakeLists.txt`, `PluginEditor.cpp`)

**Files to Revert (DSP ONLY):**
- `Source/PluginProcessor.cpp` - Audio processing logic
- `Source/PluginProcessor.h` - Processor header

**Files to PRESERVE (UI):**
- `Source/ui/public/index.html`
- `Source/ui/public/assets/hise_knob_*.png`
- `Source/PluginEditor.cpp` (unless relay bindings need fixing for Issue #1)
- `CMakeLists.txt` (asset includes)

## Completed Work (v10 UI)

**Visual Design (FINAL):**
- Main doppler knob: 176px with dual red glow layers
- Title "RED SHIFT": 78px, top: 40px
- Sub-knobs: 65px with HISE filmstrip (`hise_knob_small.png`)
- Labels: Centered underneath each knob with Handjet font
- Advanced controls: Positioned at 765px
- No "doppler effect delay" label (removed for clean center)

**Technical Implementation:**
- HISE filmstrip knobs: 128 frames, background-position animation
- Assets: `hise_knob_big.png` (4.6MB), `hise_knob_small.png` (646KB)
- BinaryData embedded via CMakeLists.txt
- Resource serving via `PluginEditor.cpp::getResource()`

**Git Commits:**
- Mockup v10: `0ada58f`
- Production implementation: `c6dbc7b`

## Next Steps

### Step 1: Diagnose UI Issue
1. Open Standalone app
2. Open browser developer tools (if available in JUCE WebView)
3. Check JavaScript console for errors
4. Verify JUCE bridge functions are defined
5. Test if parameters change when clicked (check APVTS state)

### Step 2: Fix UI Parameter Bindings
**Hypothesis:** Filmstrip JavaScript not connected to JUCE relays
**Fix Options:**
- Verify relay parameter IDs match (`DOPPLER_SHIFT`, `STEREO_WIDTH`, etc.)
- Check `setupHISEFilmstripKnob()` is calling `getSliderState()` correctly
- Ensure `sliderState.valueChangedEvent.addListener()` is working
- Confirm mouse event handlers are firing

### Step 3: Revert DSP (Preserve UI)
1. `git log plugins/RedShiftDistortion/Source/PluginProcessor.cpp` - find pre-pitch commits
2. Identify last known good DSP version
3. `git show <commit>:plugins/RedShiftDistortion/Source/PluginProcessor.cpp > Source/PluginProcessor.cpp.old`
4. Review differences between old and current DSP
5. Selectively revert problematic pitch code
6. Rebuild and test

### Step 4: Rebuild and Validate
```bash
cd plugins/RedShiftDistortion
rm -rf build
mkdir build && cd build
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ../../..
ninja RedShiftDistortion_VST3 RedShiftDistortion_AU RedShiftDistortion_Standalone
```

### Step 5: Install and Test
```bash
cp -R build/plugins/RedShiftDistortion/RedShiftDistortion_artefacts/Release/VST3/RedShiftDistortion.vst3 ~/Library/Audio/Plug-Ins/VST3/
cp -R build/plugins/RedShiftDistortion/RedShiftDistortion_artefacts/Release/AU/RedShiftDistortion.component ~/Library/Audio/Plug-Ins/Components/
open build/plugins/RedShiftDistortion/RedShiftDistortion_artefacts/Release/Standalone/RedShiftDistortion.app
```

**Test Checklist:**
- [ ] Knobs respond to mouse drag
- [ ] Parameter values update in DAW automation
- [ ] Audio processing works without pitch artifacts
- [ ] All 7 main knobs functional
- [ ] 4 bypass buttons toggle correctly
- [ ] 2 advanced controls (grain size, overlap) work
- [ ] VU meters animate

## Key Decisions Made

**UI Design:**
- HISE filmstrip knobs chosen for hardware-like appearance
- Main knob scaled to 2.1x (176px) for visual hierarchy
- Labels positioned directly underneath for clean symmetry
- Advanced controls moved left for better balance

**Technical:**
- JUCE 8 WebView integration with relay pattern
- Filmstrip rendering via background-position (not rotation)
- 128 frames per filmstrip for smooth animation

## Known Issues

1. **UI Non-Responsive** - Critical, blocking all testing
2. **DSP Pitch Artifacts** - Critical, audio quality issue
3. **Compiler Warnings** - 7 sign-conversion warnings in PluginProcessor.cpp (non-critical)

## Files Modified (Last Session)

**UI Implementation:**
- `Source/ui/public/index.html` - v10 production HTML
- `Source/ui/public/assets/hise_knob_big.png` - Main knob filmstrip
- `Source/ui/public/assets/hise_knob_small.png` - Sub-knob filmstrip
- `CMakeLists.txt` - Added knob assets to BinaryData
- `Source/PluginEditor.cpp` - Added resource serving for knobs

**Not Modified:**
- `Source/PluginProcessor.cpp` - DSP code (contains pitch issue)
- `Source/PluginProcessor.h` - Processor header

## Resume Context

When resuming:
1. Start by investigating Issue #1 (UI non-responsive)
2. Check browser console / JUCE logs for JavaScript errors
3. Verify parameter relay connections in PluginEditor constructor
4. Test if JUCE WebView bridge is loading correctly
5. Once UI works, move to Issue #2 (revert DSP pitch code)
6. Keep all UI code exactly as implemented in v10

**Priority:** Fix UI bindings FIRST, then revert DSP code.
