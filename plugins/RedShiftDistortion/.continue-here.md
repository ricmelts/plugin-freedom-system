---
plugin: RedShiftDistortion
stage: 2
phase: DSP_IMPLEMENTED
status: working_diverged_from_plan
last_updated: 2026-02-07
complexity_score: 3.0
phased_implementation: false
orchestration_mode: false
next_action: gui_implementation_or_refinement
next_phase: 3
implementation_approach: psychoacoustic_doppler_series
contract_checksums:
  creative_brief: sha256:original_concept_archived
  parameter_spec: sha256:diverged
  architecture: sha256:not_followed
  plan: sha256:superseded_by_actual_implementation
---

# Resume Point

## Current State: Working DSP Implementation (Diverged from Original Plan)

**Status:** Functional psychoacoustic doppler delay + tube saturation processor
**Architecture:** Series processing (Input → Doppler Delay → Saturation → Output)
**Build Status:** ✓ Compiles (VST3, AU)
**Testing Status:** Not yet tested in DAW

## IMPORTANT: Implementation Divergence

**Original Plan:** Parallel delay + distortion with granular pitch shifting
**Actual Implementation:** Series doppler delay + saturation with psychoacoustic stereo

The plugin evolved during development to use a psychoacoustic ITD-based doppler effect instead of the planned granular synthesis approach. This is a **working implementation** but differs significantly from `architecture.md`.

## Current DSP Architecture (Actual)

**Processing Chain:**
```
Input (Stereo)
  ↓
Doppler Delay (with ITD-based stereo spreading)
  - Differential L/R delay based on dopplerShift parameter
  - Filtered feedback loop (hi-cut + lo-cut filters)
  - Base delay: 1ms + differential ITD (±520 microseconds max)
  ↓
Tube Saturation
  - Hyperbolic tangent waveshaping
  - Adjustable drive (-12dB to +24dB)
  ↓
Master Output Gain
  ↓
Output (Stereo)
```

**Key Implementation Details:**
- **Psychoacoustic Doppler:** Uses ITD (Interaural Time Difference) for stereo width
  - Max ITD: 520 microseconds (simulates human ear separation)
  - Smoothed doppler control (0.01 smoothing factor) to prevent clicks
  - Differential delay: Left = d0 + delta, Right = d0 - delta
- **Feedback System:** Tape-style filtered feedback
  - Hi-cut lowpass filter (2-50kHz, default 8kHz)
  - Lo-cut highpass filter (50-1000Hz, default 100Hz)
  - Feedback up to 95% for tape echo effects
- **Saturation:** Simple tanh() waveshaping (musical 2nd/3rd harmonics)

## Current Parameters (8 total)

| Parameter | Type | Range | Default | Purpose |
|-----------|------|-------|---------|---------|
| saturation | Float | -12.0 to 24.0 dB | 0.0 dB | Tube saturation drive |
| dopplerShift | Float | -50.0 to 50.0 % | 0.0 % | Stereo doppler intensity |
| feedback | Float | 0.0 to 95.0 % | 0.0 % | Tape delay feedback |
| hiCut | Float | 2000.0 to 50000.0 Hz | 8000.0 Hz | Feedback lowpass |
| loCut | Float | 50.0 to 1000.0 Hz | 100.0 Hz | Feedback highpass |
| masterOutput | Float | -60.0 to 12.0 dB | 0.0 dB | Final output level |
| bypassSaturation | Bool | On/Off | Off | Bypass saturation |
| bypassDoppler | Bool | On/Off | Off | Bypass doppler delay |

**Parameters NOT Implemented from Original Plan:**
- ❌ pitchEnable (not needed - no granular pitch shifting)
- ❌ delayTime (replaced by fixed base delay + ITD differential)
- ❌ tempoSync (not implemented - no tempo sync)
- ❌ delayLevel (no parallel routing - series chain only)
- ❌ distortionLevel (no parallel routing - series chain only)

## Completed Implementation

**Stage 1 - Foundation:** ✓ Complete
- Build system (CMakeLists.txt with JUCE 8)
- APVTS parameter system
- State management (save/load)
- Placeholder UI

**Stage 2 - DSP:** ✓ Working (diverged from plan)
- Psychoacoustic doppler delay (ITD-based stereo spreading)
- Filtered feedback system (hi-cut + lo-cut)
- Tube saturation (tanh waveshaping)
- Bypass controls for troubleshooting
- Real-time safe processing

**Stage 3 - GUI:** ⚠️ Placeholder only
- Generic JUCE editor with parameter sliders
- No custom UI design implemented yet

## Next Steps Options

1. **Test in DAW:**
   - Install plugin and test audio behavior
   - Verify doppler effect works as intended
   - Check for artifacts, clicks, or instability

2. **Refine DSP:**
   - Tune smoothing factor for doppler control
   - Optimize filter coefficients
   - Add soft-clipping to prevent distortion on feedback

3. **Implement Custom GUI:**
   - Design UI mockup matching "red shift" aesthetic
   - Create custom knobs/sliders for parameters
   - Add visual feedback for doppler intensity

4. **Return to Original Plan:**
   - Implement granular pitch shifting (high complexity)
   - Add parallel routing architecture
   - Implement tempo sync system

5. **Document Current State:**
   - Create new architecture.md reflecting actual implementation
   - Update creative brief with psychoacoustic approach
   - Archive original plan as "plan-original.md"

## Key Files

**Source Code:**
- `Source/PluginProcessor.cpp` - DSP implementation (lines 90-283)
- `Source/PluginProcessor.h` - Processor class definition
- `Source/PluginEditor.cpp` - Placeholder UI
- `CMakeLists.txt` - Build configuration

**Documentation:**
- `.ideas/creative-brief.md` - Original concept (parallel architecture)
- `.ideas/architecture.md` - Original plan (NOT followed)
- `.ideas/plan.md` - Original timeline (superseded)
- `.continue-here.md` - This file (updated 2026-02-07)

## Technical Decisions Made

**Why ITD-based doppler instead of granular?**
- Lower complexity (no grain management)
- Lower CPU usage (~10% vs ~30% for granular)
- Natural stereo imaging from psychoacoustic ITD
- Simpler implementation, fewer artifacts

**Why series instead of parallel routing?**
- Doppler delay feeds into saturation (creates interesting harmonic interactions)
- Simpler to implement and debug
- Natural tape-style processing (delay → saturation is classic tape workflow)

**Why no tempo sync?**
- Focus on psychoacoustic effect (ITD is sub-millisecond, not musical timing)
- Simpler parameter set (fewer controls)
- Fixed base delay sufficient for doppler effect

## Known Issues / Considerations

- **No tempo sync:** Fixed delay time (not musical)
- **No parallel mixing:** Cannot blend dry/wet independently
- **Generic UI:** Placeholder editor only
- **Limited delay range:** Psychoacoustic ITD constrains delay to ~1ms + differential
- **Documentation mismatch:** architecture.md describes unimplemented features

**Files Created:**
- plugins/RedShiftDistortion/.ideas/creative-brief.md
- plugins/RedShiftDistortion/.ideas/architecture.md
- plugins/RedShiftDistortion/.ideas/plan.md
- plugins/RedShiftDistortion/CMakeLists.txt
- plugins/RedShiftDistortion/Source/PluginProcessor.h
- plugins/RedShiftDistortion/Source/PluginProcessor.cpp
- plugins/RedShiftDistortion/Source/PluginEditor.h
- plugins/RedShiftDistortion/Source/PluginEditor.cpp

**Build Artifacts:**
- To be generated by build-automation skill after this stage
