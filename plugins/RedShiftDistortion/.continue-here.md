---
plugin: RedShiftDistortion
stage: 0
phase: null
status: architecture_finalized
last_updated: 2026-02-08
complexity_score: 5.0
phased_implementation: true
orchestration_mode: true
next_action: implement_foundation_shell
next_phase: 1
contract_checksums:
  creative_brief: sha256:pending
  parameter_spec: sha256:none
  architecture: sha256:pending
  plan: sha256:pending
---

# Resume Point

## Current State: Architecture Finalized - Granular Doppler + Cumulative Feedback

All contract files finalized. Ready to implement according to new architecture with separated stereo width and cumulative granular doppler shift.

**ARCHITECTURE:** Stereo Width + Cumulative Granular Doppler in Feedback Loop
**Signal Flow:** Input → Stereo Width → Tape Delay (with Feedback: Granular Doppler → Saturation → Filters) → Master Output

## Completed So Far

**Ideation:** ✓ Complete
- Core concept defined: Series tape delay with separated stereo width modulation and cumulative granular doppler shift
- Creative brief finalized (2026-02-08)
- Architecture completely rewritten for final design

**Stage 0:** ✓ Complete (Finalized 2026-02-08)
- Plugin type defined: Audio Effect (Tape Delay with Cumulative Doppler)
- Professional examples researched: FabFilter Timeless 3, Eventide H3000, Roland RE-201 Space Echo
- JUCE modules identified: juce::dsp::DelayLine, juce::dsp::IIR (filters), std::tanh (saturation)
- DSP feasibility verified: Series chain with granular pitch shifting in feedback loop
- **Complexity score: 5.0** (Maximum - granular pitch shifting with cumulative feedback)
- Strategy: Phased implementation (5 DSP phases, granular engine isolated testing)
- Architecture documented: Separated stereo width + cumulative doppler + saturation
- Plan documented: 6-9 day implementation timeline

**Stage 1:** ✗ NOT STARTED
- Current codebase uses outdated architecture (parallel routing, no granular pitch shifter)
- Need to implement from scratch according to finalized architecture

## Architecture Summary (Finalized)

### Processing Chain (Series with Cumulative Feedback)

```
Input (Stereo)
  ↓
STAGE 1: Stereo Width Modulation
  - Differential L/R delay times (±260ms max)
  - Static spatial positioning (no LFO)
  - Bypass: bypassStereoWidth
  ↓
STAGE 2: Tape Delay (with Cumulative Feedback Loop)
  - Delay line (300ms max)
  - Feedback loop contains (in order):
    → STAGE 3: Granular Pitch Shifter (CUMULATIVE doppler)
       - 4-grain overlap (or 2x for lower CPU)
       - Hann windowing
       - Variable-rate grain playback
       - Bypass: bypassDoppler
    → STAGE 4: Saturation (CUMULATIVE warmth)
       - Tanh waveshaping
       - Bypass: bypassSaturation
    → Hi-cut filter (lowpass)
    → Lo-cut filter (highpass)
    → Feedback gain
  - Bypass: bypassDelay
  ↓
STAGE 5: Master Output
  - Final gain staging
  ↓
Output (Stereo)
```

### Parameters (Finalized - 15 total)

**Main Controls (7 parameters)**
1. `stereoWidth` (Float, -100.0 to 100.0%, default: 0.0%) - Spatial positioning via L/R delay differential
2. `feedback` (Float, 0.0 to 95.0%, default: 0.0%) - Feedback gain
3. `filterBandLow` (Float, 20.0 to 20000.0 Hz, default: 100.0 Hz) - Highpass cutoff in feedback
4. `filterBandHigh` (Float, 20.0 to 20000.0 Hz, default: 8000.0 Hz) - Lowpass cutoff in feedback
5. `dopplerShift` (Float, -50.0 to 50.0%, default: 0.0%) - Pitch shift per repeat (±12 semitones, **CUMULATIVE**)
6. `saturation` (Float, -12.0 to 24.0 dB, default: 0.0 dB) - Tube drive amount (**CUMULATIVE** in feedback)
7. `masterOutput` (Float, -60.0 to 12.0 dB, default: 0.0 dB) - Final output level

**Bypass Controls (4 parameters)**
8. `bypassStereoWidth` (Bool, default: false) - Bypass stereo width modulation
9. `bypassDelay` (Bool, default: false) - Bypass entire delay + feedback loop
10. `bypassDoppler` (Bool, default: false) - Bypass granular pitch shifting
11. `bypassSaturation` (Bool, default: false) - Bypass saturation stage

**Advanced Settings (2 parameters - Granular Quality Control)**
12. `grainSize` (Float, 25.0 to 200.0 ms, default: 100.0 ms) - Grain buffer size (quality vs CPU)
13. `grainOverlap` (Choice, 2x or 4x, default: 4x) - Simultaneous grains (2x = lower CPU, 4x = smoother)

**Key Concepts:**
- **stereoWidth** (spatial) and **dopplerShift** (pitch) are separate, independent effects
- **Cumulative doppler:** Each feedback repeat applies another pitch shift (exponential growth)
  - Example: +50% doppler → Repeat 1: +1 octave, Repeat 2: +2 octaves, Repeat 3: +3 octaves
- **Cumulative saturation:** Each repeat gets progressively more saturated (authentic tape echo)
- **No LFO modulation:** Removed for cleaner, more focused design

## Next Steps

1. **Implement Foundation + Shell (Stage 1)**
   - Create APVTS parameter layout with 15 parameters
   - Build system setup (CMakeLists.txt)
   - Placeholder PluginProcessor/PluginEditor
   - Verify all 15 parameters defined correctly

2. **Implement DSP (Stage 2 - 5 Phases)**
   - Phase 2.1: Stereo width + basic delay (no feedback) - 1 day
   - Phase 2.2: Granular pitch shifter (isolated testing) - 3-5 days ⚠️ HIGHEST RISK
   - Phase 2.3: Integrate granular into feedback loop - 1 day
   - Phase 2.4: Add saturation + filters to feedback - 1 day
   - Phase 2.5: Polish and optimization - 0.5-1 day

3. **Implement GUI (Stage 3)**
   - Update UI for 15 parameters
   - Add advanced settings panel (collapsible)
   - Bind all parameters via WebSliderRelay/WebToggleButtonRelay

4. **Validation (Stage 4)**
   - Create 10 presets showcasing cumulative doppler + stereo width
   - Run pluginval testing
   - Build and install

## Context to Preserve

**Key Architecture Decisions:**
- **Separated stereo width and doppler shift:** Conceptually distinct effects (spatial vs frequency)
- **Cumulative doppler in feedback loop:** Creates true unidirectional pitch shift (approaching/receding sound)
  - Pitch escalates/descends with each repeat (exponential growth)
  - Eventually shifts out of audible range (natural decay)
  - NOT oscillating wow & flutter (that would bounce up and down)
- **Granular synthesis for pitch shifting:** Lower CPU than phase vocoder, acceptable quality for creative effect
- **Saturation after granular in feedback:** Saturates the pitch-shifted signal, cumulative warmth
- **No LFO modulation:** Removed for cleaner design (doppler provides pitch movement)
- **Advanced settings:** Grain size and overlap exposed for quality tuning
- **Complexity tier:** 5.0 (Maximum - granular pitch shifting is highest complexity)

**Implementation Strategy:**
- Stage 2 (DSP): 5 phases (6-9 days total)
  - Phase 2.2 is CRITICAL PATH (granular engine, 3-5 days, 70% of project risk)
  - Implement granular in isolation first (unit test before feedback integration)
  - Test cumulative behavior thoroughly (verify pitch compounds correctly)
- Stage 3 (GUI): 1 day (update UI for 15 parameters, add collapsible advanced panel)

**Highest Risk Component:**
- Granular pitch shifter (70% of project risk)
- Most algorithmically complex (grain management, overlap-add, windowing, variable-rate playback)
- No JUCE class (custom implementation required)
- CPU cost significant (~20-40% single core depending on grain settings)
- Cumulative behavior adds testing complexity

**Mitigation Strategy:**
- Implement granular engine in isolation first
- Unit test pitch accuracy with tone generator (440 Hz → 880 Hz at +50% doppler)
- Profile CPU early and optimize if >50% single core
- Start with 2-grain overlap (simpler), scale to 4-grain if CPU allows
- Make grain settings user-adjustable (allows post-release tuning)
- Reference Curtis Roads granular synthesis literature

**Files Created (Stage 0 - Finalized):**
- plugins/RedShiftDistortion/.ideas/creative-brief.md (✓ FINALIZED 2026-02-08)
- plugins/RedShiftDistortion/.ideas/architecture.md (✓ FINALIZED 2026-02-08)
- plugins/RedShiftDistortion/.ideas/plan.md (✓ FINALIZED 2026-02-08)

**Files From Previous Implementation (OUTDATED - DO NOT USE):**
- plugins/RedShiftDistortion/CMakeLists.txt (uses outdated parameters)
- plugins/RedShiftDistortion/Source/PluginProcessor.h (parallel architecture, no granular)
- plugins/RedShiftDistortion/Source/PluginProcessor.cpp (parallel architecture, no granular)
- plugins/RedShiftDistortion/Source/PluginEditor.h (outdated parameter bindings)
- plugins/RedShiftDistortion/Source/PluginEditor.cpp (outdated parameter bindings)
- plugins/RedShiftDistortion/Source/ui/public/index.html (outdated parameters)

## Implementation Notes

**CRITICAL:** Current codebase uses outdated parallel architecture. Must implement from scratch according to finalized architecture.

**NEXT ACTION:**
1. When user is ready to implement, use `/implement RedShiftDistortion` command
2. plugin-workflow orchestrator will handle Stage 1-4 implementation
3. foundation-shell-agent will create build system + APVTS with 15 parameters
4. dsp-agent will implement 5 DSP phases (granular engine is phase 2.2)
5. gui-agent will update UI for 15 parameters with advanced panel
6. validation-agent will run after each stage

**Parameter Count Verification:**
- Total: 15 parameters (7 main + 4 bypass + 2 advanced)
- Main: stereoWidth, feedback, filterBandLow, filterBandHigh, dopplerShift, saturation, masterOutput
- Bypass: bypassStereoWidth, bypassDelay, bypassDoppler, bypassSaturation
- Advanced: grainSize, grainOverlap

**Deleted Parameters (from previous revisions):**
- ~~`lfoRate`~~ - No LFO modulation
- ~~`lfoDepth`~~ - No LFO modulation
- ~~`lfoTempoSync`~~ - No LFO modulation
- ~~`delayLevel`~~ - No parallel mixing
- ~~`distortionLevel`~~ - No parallel mixing
- ~~`pitchEnable`~~ - Removed
- ~~`delayTime`~~ - Stereo width is fixed at 260ms
- ~~`tempoSync`~~ - Removed
- ~~`reverse`~~ - Removed

**Expected Behavior:**
- Cumulative doppler creates escalating pitch shifts (intentional, not a bug)
- High feedback + high doppler may shift pitch out of audible range quickly (natural decay)
- Stereo width is static (no time-varying modulation)
- Doppler shift is unidirectional (pitch consistently rises or falls, does NOT oscillate)

**Performance Targets:**
- CPU usage: 37-57% single core at 48kHz (depends on grain settings)
- Latency: ~10-20ms (granular grain size, report for host compensation)
- No clicks, pops, or artifacts at default settings (100ms grain, 4x overlap)
- Acceptable artifacts at extreme settings (25ms grain may have slight graininess, documented)
